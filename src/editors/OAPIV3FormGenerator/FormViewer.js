import React, { useState } from 'react';
import Utils from '../../services/Utils';
import { withTheme } from '@rjsf/core';
import { Theme as AntDTheme } from '@rjsf/antd';
import { Button, message } from 'antd';
import { widgets } from './CustomWidget';
import { CustomArrayFieldTemplate, fields, fieldsView } from './CustomField';
import { json } from 'generate-schema';
import CustomFieldTemplateViewer from './CustomFieldTemplateViewer';
import CustomFieldTemplate from './CustomFieldTemplate';

const Form = withTheme(AntDTheme);

function FormViewer(props) {

  const [showButton, setShowButton] = useState(false);

  const util = Utils();

  let formData;
  let schema;
  let schemaReal = {};

  if(props.show === 'spec'){
    schema = json(props.resource.spec);
    delete schema.$schema;

    try{
      schemaReal = util.OAPIV3toJSONSchema(props.CRD.spec.validation.openAPIV3Schema).properties.spec;
      /**
       * This set the real schema properties to the leaves
       * of the autogenerated schema
       */
      util.setRealProperties(schema, schemaReal);
    }catch{}

    formData = props.resource.spec;
  } else {
    schema = json(props.resource[props.show]);
    delete schema.$schema;
    formData = props.resource[props.show];
  }

  const submit = (value) => {
    let item = {}

    item[props.show] = value.formData

    let namespace = null;

    if(props.resource.metadata.namespace){
      namespace = props.resource.metadata.namespace;
    }

    let promise;

    if(props.CRD){
      promise = window.api.updateCustomResource(
        props.CRD.spec.group,
        props.CRD.spec.version,
        namespace,
        props.CRD.spec.names.plural,
        props.resource.metadata.name,
        item
      );
    } else {
      promise = props.updateFunc(
        props.resource.metadata.name,
        props.resource.metadata.namespace,
        item
      )
    }

    promise
      .catch((error) => {
        console.log(error);
        message.error('Could not update the resource');
      });
  }

  return(
    <div key={props.show}>
      <Form
        uiSchema = {{ "ui:disabled": true }}
        schema={schema}
        formData={formData}
        onChange={() => {
          if(!showButton && ((props.show !== 'status' || props.show !== 'metadata' || props.readonly) && !props.onEditor))
            setShowButton(true);
        }}
        fields={((props.show === 'status' || props.show === 'metadata' || props.readonly) || props.onEditor) ? fields : fieldsView}
        FieldTemplate={((props.show === 'status' || props.show === 'metadata' || props.readonly) || props.onEditor) ? CustomFieldTemplate : CustomFieldTemplateViewer}
        ArrayFieldTemplate={CustomArrayFieldTemplate}
        widgets={widgets}
        onSubmit={submit}
      >
        {showButton ? (
          <Button type="primary" htmlType={'submit'} style={{marginTop: 10}}>Save changes</Button>
        ) : <div/>}
      </Form>
    </div>
  )
}

export default FormViewer;
